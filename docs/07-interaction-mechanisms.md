# 系统互动机制详解

## 概述

Tmux-AI 通过四层架构实现 AI Agent 的自主工作和多 Agent 协调。

---

## 架构总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Tmux-AI 系统架构                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        应用层 (斜杠命令)                            │ │
│  │  /tmuxAI:pm-oversight  /tmuxAI:role-developer  /tmuxAI:pm-assign   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│                                    ▼                                     │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        自动化层                                     │ │
│  │     schedule-checkin (拉取式)  │  _pm_stop_hook (推送式)  │  auto-commit │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│                                    ▼                                     │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        通信层                                       │ │
│  │            tsc (消息发送)  │  send-status (状态协议)  │  broadcast     │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│                                    ▼                                     │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        基础设施层                                   │ │
│  │              tmux (会话管理)  │  at (定时任务)  │  git (版本控制)      │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 核心组件

### 基础设施层

| 组件 | 功能 | 依赖 |
|------|------|------|
| **tmux** | 会话持久化、窗口管理 | 系统安装 |
| **at/atd** | 系统级定时任务调度 | 系统安装 + 服务启动 |
| **git** | 版本控制、进度保存 | 系统安装 |

### 通信层

| 组件 | 功能 | 底层实现 |
|------|------|----------|
| **tsc** | 向 tmux 窗口发送消息 | `tmux send-keys` + 双 Enter |
| **send-status** | 结构化状态汇报 | 基于 tsc 的协议封装 |
| **broadcast** | 向所有 Agent 广播 | 遍历会话 + tsc |

### 自动化层

| 组件 | 模式 | 底层机制 | 通知 PM |
|------|------|----------|---------|
| **schedule-checkin** | 拉取式 | `at` 命令定时触发 | 间接（唤醒 Agent） |
| **_pm_stop_hook** | 推送式 | Claude Hook 事件触发 | **直接** |
| **start-auto-commit** | 定时式 | 后台进程 + `sleep` 循环 | 否 |

> 详细实现参见 [自调度功能详解](06-self-scheduling.md)

### 应用层：核心斜杠命令

| 命令 | 类型 | 作用对象 | 功能 |
|------|------|----------|------|
| **pm-oversight** | 角色激活 | 当前 Agent | 变成 PM，监督其他 Agent |
| **role-developer** | 角色激活 | 当前 Agent | 变成开发者，执行任务 |
| **pm-assign** | 操作执行 | 目标槽位 | PM 向槽位分配任务 |

**调用关系**：
```
用户 ─── /pm-oversight ───▶ Agent 变成 PM ─── /pm-assign ───▶ 启动 Engineer
  │                                                              │
  │                                                    (自动激活 role-developer)
  │
  └─── /role-developer ───▶ Agent 直接开发（无 PM 模式）
```

---

## 角色与自动化交互

| 自动化组件 | PM | Developer/Engineer |
|------------|-----|-------------------|
| **schedule-checkin** | 安排定期检查进度 | 等待构建/测试完成 |
| **_pm_stop_hook** | 接收通知（被动） | 触发通知（输出 `[STATUS:*]`） |
| **auto-commit** | 不使用 | 可选使用 |

**状态标记协议**（触发 Hook）：
```
[STATUS:DONE] 完成说明      → 标记 done，通知 PM
[STATUS:ERROR] 错误说明     → 标记 error，告警 PM
[STATUS:BLOCKED] 阻塞原因   → 标记 blocked，请求帮助
```

---

## 组件交互矩阵

| 发起方 | 接收方 | 机制 | 场景 |
|--------|--------|------|------|
| 用户 | Agent | `fire` / `tsc` | 启动任务 |
| Agent | Agent | `tsc` | 跨项目协调 |
| Agent | 自己 | `schedule-checkin` → `at` → `tsc` | 自我唤醒 |
| Engineer | PM | `_pm_stop_hook` | 状态推送 |
| PM | Engineer | `pm-assign` → `tsc` | 任务分配 |
| PM | 所有 Agent | `pm-broadcast` | 广播通知 |

---

## 关键流程：PM 监督时序

```
     PM                         Engineer                    系统
      │                              │                        │
  T0  │  pm-assign dev-1 "任务"      │                        │
      │─────────────────────────────▶│                        │
      │                              │                        │
      │  schedule-checkin 30         │  开始工作               │
      │──────────────────────────────────────────────────────▶│
      │                              │                        │
      │  [等待]                      │  工作中...              │
      │                              │  schedule-checkin 15   │
      │                              │───────────────────────▶│
      │                              │                        │
 T30  │◀─────────────────────────────────────────── at 触发 ──│
      │  唤醒: "检查进度"             │                        │
      │                              │◀────────── at 触发 ────│
      │  pm-check → idle             │  唤醒，继续工作         │
      │                              │                        │
 T45  │                              │  [STATUS:DONE]         │
      │                              │───────────────────────▶│
      │◀──────────────────────────────────────── Hook 通知 ───│
      │  "dev-1 完成"                │                        │
      │                              │                        │
      │  pm-assign dev-1 下一任务     │                        │
      │─────────────────────────────▶│                        │
      ▼                              ▼                        ▼
```

---

## 故障恢复

| 故障 | 影响 | 恢复方法 |
|------|------|----------|
| tmux 崩溃 | 会话丢失 | `fire` 重新启动 |
| atd 停止 | 自调度失效 | `systemctl start atd` |
| Hook 配置错误 | 推送失效 | 检查 `settings.json` |
| tsc 目标错误 | 消息失败 | 检查 `session:window` 格式 |

**状态检查命令**：
```bash
check-deps          # 检查所有依赖
check-agent <session>  # 检查 Agent 状态
pm-status           # 检查槽位状态
atq                 # 查看待执行任务
```

---

## 设计原则

| 原则 | 说明 |
|------|------|
| **松耦合** | 组件通过消息传递交互，Agent 不知道谁在监控它 |
| **可降级** | `at` 不可用 → 后台 `sleep`；Hook 失效 → 手动 `pm-check` |
| **可观测** | `pm-status`、`check-agent`、`monitor-snapshot`、`atq` |
| **幂等性** | 重复操作不产生副作用 |

---

## 相关链接

- [自调度功能详解](06-self-scheduling.md) - schedule-checkin 深入分析
- [PM 监督模式](03-pm-oversight-mode.md) - 槽位管理和监督流程
- [Agent 角色](04-agent-roles.md) - 各角色职责和协作
