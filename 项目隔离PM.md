# 项目隔离 PM 系统设计文档

> 📅 Last updated: 2026-01-17
>
> 简化版：一个项目一个 PM，保持系统简单可控

---

## 1. 核心原则

| 原则 | 说明 |
|------|------|
| **一项目一PM** | 每个 tmux 会话内有一个 PM，只管本项目 |
| **会话即隔离** | 不同项目 = 不同 tmux 会话，天然隔离 |
| **窗口即槽位** | 同一会话内的窗口作为 Agent 槽位 |
| **窗口名即角色** | 从窗口名推断角色，零存储 |
| **保持简单** | 复用现有机制，最小改动 |

---

## 2. 系统架构

### 2.1 项目隔离架构

```
项目 A (tmux session: proj-A)        项目 B (tmux session: proj-B)
┌─────────────────────────────┐     ┌─────────────────────────────┐
│  ┌─────┬───────┬───────┐   │     │  ┌─────┬───────┬───────┐   │
│  │ PM  │ dev-1 │ dev-2 │   │     │  │ PM  │ dev-1 │  qa   │   │
│  │窗口 │ 窗口  │ 窗口  │   │     │  │窗口 │ 窗口  │ 窗口  │   │
│  └─────┴───────┴───────┘   │     │  └─────┴───────┴───────┘   │
│       只管自己项目           │     │       只管自己项目           │
└─────────────────────────────┘     └─────────────────────────────┘
          │                                    │
          └──────────── 互不干扰 ──────────────┘
```

### 2.2 四层系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Tmux-AI 系统架构                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        应用层 (斜杠命令)                            │ │
│  │  /tmuxAI:pm-oversight  /tmuxAI:role-developer  /tmuxAI:pm-assign   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│                                    ▼                                     │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        自动化层                                     │ │
│  │     schedule-checkin (拉取式)  │  _pm_stop_hook (推送式)  │  auto-commit │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│                                    ▼                                     │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        通信层                                       │ │
│  │            tsc (消息发送)  │  send-status (状态协议)  │  broadcast     │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│                                    ▼                                     │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        基础设施层                                   │ │
│  │              tmux (会话管理)  │  at (定时任务)  │  git (版本控制)      │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心组件

### 3.1 基础设施层

| 组件 | 功能 | 依赖 |
|------|------|------|
| **tmux** | 会话持久化、窗口管理 | 系统安装 |
| **at/atd** | 系统级定时任务调度 | 系统安装 + 服务启动 |
| **git** | 版本控制、进度保存 | 系统安装 |

### 3.2 通信层

| 组件 | 功能 | 底层实现 |
|------|------|----------|
| **tsc** | 向 tmux 窗口发送消息 | `tmux send-keys` + 双 Enter |
| **send-status** | 结构化状态汇报 | 基于 tsc 的协议封装 |
| **pm-broadcast** | 向所有 Agent 广播 | 遍历槽位 + tsc |

### 3.3 自动化层

| 组件 | 模式 | 底层机制 | 通知 PM |
|------|------|----------|---------|
| **schedule-checkin** | 拉取式 | `at` 命令定时触发 | 间接（唤醒 Agent） |
| **_pm_stop_hook** | 推送式 | Claude Hook 事件触发 | **直接** |
| **start-auto-commit** | 定时式 | 后台进程 + `sleep` 循环 | 否 |

#### Hook 推送式通知架构

```
   Engineer Agent                   _pm_stop_hook                     PM Agent
        │                                 │                               │
        │  输出 [STATUS:DONE]              │                               │
        ├─────────────────────────────────│                               │
        │                                 │                               │
        │  Claude Code Stop 事件          │                               │
        │─────────────────────────────────▶                               │
        │                                 │                               │
        │                        1. 获取窗口信息                           │
        │                           (via TMUX_PANE)                       │
        │                                 │                               │
        │                        2. 检测状态标记                           │
        │                           [STATUS:*]                            │
        │                                 │                               │
        │                        3. 调用 pm-mark                          │
        │                           更新状态变量                           │
        │                                 │                               │
        │                        4. tsc 发送通知                           │
        │                                 │───────────────────────────────▶
        │                                 │         "[Hook] dev-1 → done" │
        ▼                                 ▼                               ▼
```

**核心流程**：

1. **事件触发**：Agent 输出 `[STATUS:DONE/ERROR/BLOCKED]` 后，Claude Code 停止工作
2. **Hook 执行**：Claude Code Stop 事件触发 `_pm_stop_hook`
3. **状态检测**：Hook 捕获终端最近 30 行输出，正则匹配状态标记
4. **状态更新**：调用 `pm-mark` 更新 tmux 环境变量，记录耗时
5. **PM 通知**：向 PM 窗口（Claude/pm）发送格式化通知

**防抖机制**：相同状态不重复通知，避免重复触发。

#### TMUX_PANE 环境变量

**问题背景**：

当 Claude Code 的 Hook 在后台 tmux 窗口中执行时，`tmux display-message -p '#{window_name}'` 返回的是**当前活跃窗口**（如 PM 窗口），而非 Hook 实际所在的窗口。这会导致：

- Hook 错误地认为自己在 PM 窗口中运行
- 状态标记无法正确关联到 Engineer 槽位
- PM 收不到状态推送通知

**解决方案**：

使用 `$TMUX_PANE` 环境变量。这是 tmux 为每个 pane 设置的唯一标识符（如 `%0`, `%1`），在 Hook 执行时保持不变。

```bash
# _get_tmux_info 辅助函数
_get_tmux_info() {
    local type="${1:-both}"
    local pane_id="${TMUX_PANE:-}"

    case "$type" in
        session)
            tmux display-message -t "$pane_id" -p '#{session_name}'
            ;;
        window)
            tmux display-message -t "$pane_id" -p '#{window_name}'
            ;;
        both)
            tmux display-message -t "$pane_id" -p '#{session_name}:#{window_name}'
            ;;
    esac
}
```

**关键点**：通过 `-t "$pane_id"` 指定目标 pane，而非依赖当前活跃窗口。

**影响的函数**：

| 函数 | 使用场景 |
|------|----------|
| `_pm_stop_hook` | Hook 中获取正确的槽位名 |
| `tsc` | 添加正确的消息来源前缀 |
| `get-role` | 推断当前窗口角色 |
| `schedule-checkin` | 确定唤醒目标窗口 |

### 3.4 应用层

| 命令 | 类型 | 功能 |
|------|------|------|
| **pm-oversight** | 角色激活 | 变成 PM，监督其他 Agent |
| **role-developer** | 角色激活 | 变成开发者，执行任务 |
| **pm-assign** | 操作执行 | PM 向槽位分配任务 |

---

## 4. 自调度机制

### 4.1 问题与解决

```
传统模式:                              自调度模式:
┌────────────────────────┐            ┌────────────────────────┐
│ 用户: "运行测试"         │            │ 用户: "运行测试"         │
│ AI: "需要 30 分钟..."    │            │ AI: "需要 30 分钟"       │
│                         │            │ AI: schedule-checkin 30 │
│ [30 分钟后]              │            │                         │
│                         │            │ [用户可以离开]           │
│ 用户: "完了吗？" ← 必须问 │            │                         │
│ AI: "让我检查..."        │            │ [30 分钟后 - 自动触发]   │
└────────────────────────┘            │ AI: "测试完成，修复..."   │
                                       └────────────────────────┘
```

### 4.2 工作原理

```
   Claude Agent                    系统层
   ┌──────────────┐               ┌──────────────┐
   │ 1. 执行任务   │               │              │
   │ 2. 需要等待   │               │              │
   │ 3. 调用      │   创建定时任务  │   at 守护进程  │
   │ schedule-   │──────────────▶│   (atd)      │
   │ checkin     │               │              │
   │ 4. 停止工作  │               │   等待...     │
   │    (休眠)    │               │              │
   │              │   N分钟后触发   │              │
   │ 5. 被唤醒   │◀──────────────│   执行 tsc   │
   │ 6. 继续工作  │               │              │
   └──────────────┘               └──────────────┘
```

### 4.3 使用示例

```bash
# 语法
schedule-checkin <分钟> <备注> [目标]

# 示例
schedule-checkin 30 "检查测试结果"
schedule-checkin 60 "确认部署状态" my-project:Claude
```

### 4.4 降级机制

| 优先级 | 方法 | 可靠性 |
|--------|------|--------|
| 1 | `at` 命令 | 高（系统级，关闭终端不影响） |
| 2 | 后台 `sleep` | 低（关闭终端会丢失） |

---

## 5. 角色识别

### 5.1 窗口命名规则

通过窗口名推断角色，**零存储、零持久化**：

| 窗口名模式 | 角色 |
|------------|------|
| `dev-*` (dev-1, dev-2...) | Developer |
| `qa-*` 或 `qa` | QA |
| `devops-*` 或 `devops` | DevOps |
| `reviewer-*` 或 `reviewer` | Reviewer |
| `PM` 或 `Claude` | PM |

### 5.2 实现

```bash
get-role() {
    local window="${1:-$(_get_tmux_info window)}"  # 使用 _get_tmux_info 获取正确窗口名
    case "$window" in
        dev-*|dev)           echo "Developer" ;;
        qa-*|qa)             echo "QA" ;;
        devops-*|devops)     echo "DevOps" ;;
        reviewer-*|reviewer) echo "Reviewer" ;;
        PM|Claude)           echo "PM" ;;
        *)                   echo "Unknown" ;;
    esac
}
```

### 5.3 优势对比

| 对比项 | 持久化方案 | 命名规则方案 |
|--------|------------|--------------|
| 存储 | 需要文件/变量 | **零存储** |
| 恢复 | 需要恢复机制 | **自动恢复** |
| 一致性 | 可能不同步 | **天然一致** |
| tmux 崩溃 | 数据丢失 | **无影响** |

---

## 6. 消息溯源

### 6.1 问题

`tsc` 发送的消息不包含来源，PM 不知道是哪个槽位发的。

### 6.2 解决方案

增强 `tsc`，自动附加发送方窗口名：

```bash
# 发送消息
tsc dev-1 "API 完成了"

# PM 收到的消息格式
[Claude] API 完成了
```

---

## 7. 组件交互

### 7.1 交互矩阵

| 发起方 | 接收方 | 机制 | 场景 |
|--------|--------|------|------|
| 用户 | Agent | `fire` / `tsc` | 启动任务 |
| Agent | Agent | `tsc` | 跨窗口协调 |
| Agent | 自己 | `schedule-checkin` → `at` → `tsc` | 自我唤醒 |
| Engineer | PM | `_pm_stop_hook` | 状态推送 |
| PM | Engineer | `pm-assign` → `tsc` | 任务分配 |
| PM | 所有 Agent | `pm-broadcast` | 广播通知 |

### 7.2 PM 监督时序

```
     PM                         Engineer                    系统
      │                              │                        │
  T0  │  pm-assign dev-1 "任务"      │                        │
      │─────────────────────────────▶│                        │
      │                              │                        │
      │  schedule-checkin 30         │  开始工作               │
      │──────────────────────────────────────────────────────▶│
      │                              │                        │
      │  [等待]                      │  工作中...              │
      │                              │  schedule-checkin 15   │
      │                              │───────────────────────▶│
      │                              │                        │
 T30  │◀─────────────────────────────────────────── at 触发 ──│
      │  唤醒: "检查进度"             │                        │
      │                              │◀────────── at 触发 ────│
      │  pm-check → idle             │  唤醒，继续工作         │
      │                              │                        │
 T45  │                              │  [STATUS:DONE]         │
      │                              │───────────────────────▶│
      │◀──────────────────────────────────────── Hook 通知 ───│
      │  "dev-1 完成"                │                        │
      │                              │                        │
      │  pm-assign dev-1 下一任务     │                        │
      │─────────────────────────────▶│                        │
      ▼                              ▼                        ▼
```

---

## 8. 故障恢复

| 故障 | 影响 | 恢复方法 |
|------|------|----------|
| tmux 崩溃 | 会话丢失 | `fire` 重新启动 |
| atd 停止 | 自调度失效 | `systemctl start atd` |
| Hook 配置错误 | 推送失效 | 检查 `settings.json` |
| tsc 目标错误 | 消息失败 | 检查 `session:window` 格式 |

**状态检查命令**：
```bash
check-deps          # 检查所有依赖
pm-status           # 检查槽位状态
atq                 # 查看待执行任务
```

---

## 9. 设计原则

| 原则 | 说明 |
|------|------|
| **松耦合** | 组件通过消息传递交互，Agent 不知道谁在监控它 |
| **可降级** | `at` 不可用 → 后台 `sleep`；Hook 失效 → 手动 `pm-check` |
| **可观测** | `pm-status`、`check-agent`、`monitor-snapshot`、`atq` |
| **幂等性** | 重复操作不产生副作用 |

---

## 10. 能力评估

### 10.1 已具备（可直接使用）

| 能力 | 函数/命令 | 状态 |
|------|-----------|------|
| 项目隔离 | `fire` 创建独立会话 | ✅ 已有 |
| 槽位管理 | `pm-init-slots`, `pm-add-slot` | ✅ 已有 |
| 任务分配 | `pm-assign` | ✅ 已有 |
| 状态监控 | `pm-status`, `pm-check` | ✅ 已有 |
| 状态推送 | `_pm_stop_hook` | ✅ 已有 |
| 自调度 | `schedule-checkin` | ✅ 已有 |
| 消息溯源 | `tsc` 自动添加来源 | ✅ 已有 |
| 角色识别 | `get-role` 命名规则 | ✅ 已有 |

### 10.2 验收标准

- [x] 项目 A 的 PM 无法操作项目 B 的槽位（天然满足）
- [x] PM 收到消息时能看到来源槽位（如 `[dev-1] 消息`）
- [x] `get-role dev-1` 返回 `Developer`
- [x] `pm-status` 显示每个槽位的角色
- [x] 系统保持简单，无持久化存储

---

## 11. 总结

**核心设计**：
- 一个 tmux 会话 = 一个项目
- PM 只管本会话内的窗口槽位
- 项目间通过会话隔离
- **窗口名即角色，无需持久化**
- 自调度实现 Agent 自主工作
- Hook 机制实现状态推送
