# 项目隔离 PM 系统需求文档

> 简化版：一个项目一个 PM，保持系统简单可控

---

## 1. 核心原则

| 原则 | 说明 |
|------|------|
| **一项目一PM** | 每个 tmux 会话内有一个 PM，只管本项目 |
| **会话即隔离** | 不同项目 = 不同 tmux 会话，天然隔离 |
| **窗口即槽位** | 同一会话内的窗口作为 Agent 槽位 |
| **窗口名即角色** | 从窗口名推断角色，零存储 |
| **保持简单** | 复用现有机制，最小改动 |

---

## 2. 架构确认

```
项目 A (tmux session: proj-A)        项目 B (tmux session: proj-B)
┌─────────────────────────────┐     ┌─────────────────────────────┐
│  ┌─────┬───────┬───────┐   │     │  ┌─────┬───────┬───────┐   │
│  │ PM  │ dev-1 │ dev-2 │   │     │  │ PM  │ dev-1 │  qa   │   │
│  │窗口 │ 窗口  │ 窗口  │   │     │  │窗口 │ 窗口  │ 窗口  │   │
│  └─────┴───────┴───────┘   │     │  └─────┴───────┴───────┘   │
│       只管自己项目           │     │       只管自己项目           │
└─────────────────────────────┘     └─────────────────────────────┘
          │                                    │
          └──────────── 互不干扰 ──────────────┘
```

**这就是现有设计**，已经满足项目隔离需求。

---

## 3. 现有能力评估

### 3.1 已具备（可直接使用）

| 能力 | 函数/命令 | 状态 |
|------|-----------|------|
| 项目隔离 | `fire` 创建独立会话 | ✅ 已有 |
| 槽位管理 | `pm-init-slots`, `pm-add-slot` | ✅ 已有 |
| 任务分配 | `pm-assign` | ✅ 已有 |
| 状态监控 | `pm-status`, `pm-check` | ✅ 已有 |
| 状态推送 | `_pm_stop_hook` | ✅ 已有 |
| 自调度 | `schedule-checkin` | ✅ 已有 |

### 3.2 需要增强（小幅改动）

| 能力 | 现状 | 改进建议 | 优先级 |
|------|------|----------|--------|
| **消息溯源** | tsc 无发送方 | 消息自动带窗口名 | P1 |
| **角色识别** | 无机制 | 窗口命名规则推断 | P1 |
| **运行状态可见** | 需主动查询 | pm-status 增加实时指示 | P2 |

---

## 4. 需要改进的功能

### 4.1 消息溯源（P1）

**问题**：`tsc` 发送的消息不包含来源，PM 不知道是哪个槽位发的。

**改进方案**：增强 `tsc`，自动附加发送方窗口名。

```bash
# 改进后的 tsc（内部自动添加来源）
tsc dev-1 "API 完成了"

# PM 收到的消息格式
[dev-1] API 完成了
```

**实现**（修改 bashrc-ai-automation-v2.sh）：
```bash
tsc() {
    local from=$(tmux display-message -p '#{window_name}' 2>/dev/null)
    local target="$1"
    shift
    local msg="[$from] $*"
    tmux send-keys -t "$target" "$msg" C-m
    sleep "${TSC_DELAY:-$DEFAULT_DELAY}"
    tmux send-keys -t "$target" Enter
}
```

### 4.2 角色识别：窗口命名规则（P1）

**问题**：Agent 不知道自己是什么角色，无法自动汇报身份。

**改进方案**：通过窗口命名规则推断角色，**零存储、零持久化**。

#### 命名规则

| 窗口名模式 | 角色 |
|------------|------|
| `dev-*` (dev-1, dev-2...) | Developer |
| `qa-*` 或 `qa` | QA |
| `devops-*` 或 `devops` | DevOps |
| `reviewer-*` 或 `reviewer` | Reviewer |
| `PM` 或 `Claude` | PM |

#### 实现

```bash
# 新增函数：从窗口名推断角色
get-role() {
    local window="${1:-$(tmux display-message -p '#{window_name}')}"
    case "$window" in
        dev-*|dev)           echo "Developer" ;;
        qa-*|qa)             echo "QA" ;;
        devops-*|devops)     echo "DevOps" ;;
        reviewer-*|reviewer) echo "Reviewer" ;;
        PM|Claude)           echo "PM" ;;
        *)                   echo "Unknown" ;;
    esac
}
```

#### 优势

| 对比项 | 持久化方案 | 命名规则方案 |
|--------|------------|--------------|
| 存储 | 需要文件/变量 | **零存储** |
| 恢复 | 需要恢复机制 | **自动恢复** |
| 一致性 | 可能不同步 | **天然一致** |
| 维护 | 需要清理 | **无需维护** |
| tmux 崩溃 | 数据丢失 | **无影响** |

#### 约束

- 创建槽位时必须遵循命名规范
- `pm-add-slot` 已使用 `dev-1`, `qa` 等名称，**天然兼容**

### 4.3 状态可见性（P2）

**问题**：`auto-commit` 等后台任务无持续可见指示。

**改进方案**：`pm-status` 增加运行中任务的显示。

```bash
pm-status
# 输出:
# ┌─────────────────────────────────────┐
# │ 槽位状态                             │
# ├─────────────────────────────────────┤
# │ dev-1: working (Developer)         │
# │ dev-2: idle    (Developer)         │
# │ qa:    done    (QA)                │
# ├─────────────────────────────────────┤
# │ 后台任务                             │
# │ • auto-commit: 运行中 (每30分钟)     │
# │ • schedule-checkin: 15分钟后触发    │
# └─────────────────────────────────────┘
```

---

## 5. 不需要改动的部分

| 功能 | 理由 |
|------|------|
| 项目隔离机制 | tmux 会话天然隔离，已满足 |
| PM 调度逻辑 | 现有 pm-assign/pm-check 已够用 |
| Hook 机制 | _pm_stop_hook 已实现推送 |
| 槽位创建/销毁 | pm-add-slot/pm-remove-slot 已有 |

---

## 6. 实现计划

### Phase 1：消息溯源 + 角色识别

| 任务 | 文件 | 工作量 |
|------|------|--------|
| 修改 `tsc` 函数，自动添加发送方窗口名 | bashrc-ai-automation-v2.sh | 30 分钟 |
| 新增 `get-role` 函数 | bashrc-ai-automation-v2.sh | 15 分钟 |
| `pm-status` 显示角色信息 | bashrc-ai-automation-v2.sh | 30 分钟 |
| 测试跨窗口消息 | - | 15 分钟 |

### Phase 2：状态可见性（可选）

| 任务 | 文件 | 工作量 |
|------|------|--------|
| `pm-status` 增加后台任务显示 | bashrc-ai-automation-v2.sh | 30 分钟 |
| 考虑 tmux 状态栏指示 | - | 可选 |

---

## 7. 验收标准

- [ ] 项目 A 的 PM 无法操作项目 B 的槽位（天然满足）
- [ ] PM 收到消息时能看到来源槽位（如 `[dev-1] 消息`）
- [ ] `get-role dev-1` 返回 `Developer`
- [ ] `pm-status` 显示每个槽位的角色
- [ ] 系统保持简单，无持久化存储

---

## 8. 总结

**改动范围极小**：
- 现有架构已满足项目隔离
- 角色识别通过命名规则，零存储
- 只需增强 2 个函数（tsc、get-role）

**核心设计**：
- 一个 tmux 会话 = 一个项目
- PM 只管本会话内的窗口槽位
- 项目间通过会话隔离
- **窗口名即角色，无需持久化**
